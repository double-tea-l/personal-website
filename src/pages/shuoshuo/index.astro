---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const list = (await getCollection("shuoshuo")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

function imagePaths(images: { image?: string }[] | string[]): string[] {
  if (!images?.length) return [];
  return images.map((i) => (typeof i === "string" ? i : i.image ?? "")).filter(Boolean);
}

function isSafeLink(url: string | undefined): boolean {
  if (!url || typeof url !== "string") return false;
  const t = url.trim();
  return t.startsWith("http://") || t.startsWith("https://");
}

/** 从 iframe 代码里取出 src，并规范为 https；仅允许常见音乐站，避免随意嵌入 */
const ALLOWED_EMBED_HOSTS = ["music.163.com", "y.qq.com", "open.spotify.com"];
function getEmbedSrc(raw: string | undefined): string | null {
  if (!raw || typeof raw !== "string") return null;
  const m = raw.match(/src\s*=\s*["']([^"']+)["']/i);
  if (!m) return null;
  let src = m[1].trim();
  if (src.startsWith("//")) src = "https:" + src;
  if (!src.startsWith("http://") && !src.startsWith("https://")) return null;
  try {
    const u = new URL(src);
    if (ALLOWED_EMBED_HOSTS.some((h) => u.hostname === h || u.hostname.endsWith("." + h)))
      return src;
  } catch {
    return null;
  }
  return null;
}

const items = await Promise.all(
  list.map(async (item) => ({
    ...item,
    Content: (await item.render()).Content,
    imgs: imagePaths(item.data.images as { image?: string }[] | string[]),
    timeStr: item.data.date.toLocaleString("zh-CN", {
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
    }),
  }))
);
---

<Layout title="说说" description="随手记、灵感与碎片">
  <h1 class="mb-2">说说</h1>
  <p class="text-[#57534e] text-sm mb-8">随口几句、灵感、图与歌。</p>

  <ul class="shuoshuo-list">
    {items.map((item) => {
      const Content = item.Content;
      return (
        <li class="shuoshuo-card">
          <time class="shuoshuo-time" datetime={item.data.date.toISOString()}>
            {item.timeStr}
          </time>
          <div class="shuoshuo-body">
            <Content />
          </div>
        {item.imgs.length > 0 && (
          <div class="shuoshuo-images">
            {item.imgs.map((src) => (
              <img src={src} alt="" class="shuoshuo-img" loading="lazy" />
            ))}
          </div>
        )}
        {(item.data.musicUrl ?? item.data.musicTitle) && (() => {
          const embedSrc = getEmbedSrc(item.data.musicUrl);
          return (
          <div class="shuoshuo-music">
            {embedSrc ? (
              <iframe
                class="shuoshuo-music-iframe"
                frameborder="0"
                border="0"
                marginWidth="0"
                marginHeight="0"
                width="330"
                height="86"
                src={embedSrc}
                title={item.data.musicTitle || "音乐播放"}
              />
            ) : isSafeLink(item.data.musicUrl) ? (
              <a
                href={item.data.musicUrl!.trim()}
                target="_blank"
                rel="noopener noreferrer"
                class="shuoshuo-music-link"
              >
                {item.data.musicTitle || "听歌"}
              </a>
            ) : (
              <span class="text-[#78716c]">
                {item.data.musicTitle || (item.data.musicUrl ? "支持：填网易云/QQ/Spotify 的 iframe 嵌入代码，或填 https 链接" : "")}
              </span>
            )}
          </div>
          );
        })()}
        </li>
      );
    })}
  </ul>
</Layout>
