---
import Layout from "../layouts/Layout.astro";
import { siteConfig } from "../config/site";
import WritingActivity from "../components/WritingActivity.astro";
import { getCollection } from "astro:content";

const TZ = "America/Los_Angeles";

function dateStrInPST(d: Date): string {
  return d.toLocaleDateString("en-CA", { timeZone: TZ });
}

function addDaysPST(dateStr: string, days: number): string {
  const t = new Date(dateStr + "T12:00:00").getTime() + days * 24 * 60 * 60 * 1000;
  return new Date(t).toLocaleDateString("en-CA", { timeZone: TZ });
}

function getSundayPST(dateStr: string): string {
  const d = new Date(dateStr + "T12:00:00");
  const day = new Date(d).toLocaleDateString("en-US", { timeZone: TZ, weekday: "short" });
  const dow = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].indexOf(day);
  if (dow <= 0) return dateStr;
  return addDaysPST(dateStr, -dow);
}

const posts = (await getCollection("blog")).filter((p) => !p.data.draft);
const dayCount: Record<string, number> = {};
for (const p of posts) {
  const key = dateStrInPST(p.data.date);
  dayCount[key] = (dayCount[key] ?? 0) + 1;
}

const todayPST = dateStrInPST(new Date());
const startDatePST = addDaysPST(todayPST, -364);
const weekStartPST = getSundayPST(startDatePST);

const COLS = 53;
const ROWS = 7;
const grid: number[][] = [];
for (let c = 0; c < COLS; c++) {
  const col: number[] = [];
  for (let r = 0; r < ROWS; r++) {
    const cellDatePST = addDaysPST(weekStartPST, c * 7 + r);
    if (cellDatePST < startDatePST || cellDatePST > todayPST) {
      col.push(-1);
    } else {
      const count = dayCount[cellDatePST] ?? 0;
      col.push(Math.min(count, 4));
    }
  }
  grid.push(col);
}

const activeDays = Object.keys(dayCount).length;
const totalPosts = posts.length;
---

<Layout title={siteConfig.title} description={siteConfig.description}>
  <h1 class="mb-4 text-2xl font-bold">{siteConfig.title}</h1>
  <p class="text-[#57534e] mt-2">{siteConfig.description}</p>
  <p class="mt-8">
    <a href="/blog">文章</a>
    ·
    <a href="/shuoshuo">说说</a>
    ·
    <a href="/archive">归档</a>
    ·
    <a href="/photos">相册</a>
  </p>

  <WritingActivity
    grid={grid}
    activeDays={activeDays}
    totalPosts={totalPosts}
    weekStart={weekStartPST}
  />
</Layout>
